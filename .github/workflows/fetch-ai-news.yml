name: Fetch AI News Daily

on:
  schedule:
    - cron: "0 9 * * *"  # æ¯å¤©ä¸Šåˆ9ç‚¹è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  fetch-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # æ·»åŠ å†™å…¥ä»“åº“å†…å®¹çš„æƒé™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install requests Jinja2 weasyprint
          sudo apt-get update && sudo apt-get install -y libcairo2-dev libpango1.0-dev libgdk-pixbuf2.0-dev libffi-dev shared-mime-info

      - name: Set current date
        id: date
        run: |
          echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "TAG_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Fetch AI News
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: |
          python -c "import os; f=open('fetch_ai_news.py','r'); content=f.read(); f.close(); f=open('fetch_ai_news.py','w'); f.write(content.replace('YOUR_NEWSAPI_KEY', os.environ['NEWS_API_KEY'])); f.close()"
          python fetch_ai_news.py

      - name: Translate News to Chinese
        env:
          # æ™ºè°±AIç¿»è¯‘API
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          ZHIPU_MODEL: ${{ secrets.ZHIPU_MODEL || 'glm-4-flash' }}
        run: |
          python translate.py ai_news_${{ env.TODAY }}.json
          # å¦‚æœç¿»è¯‘å¤±è´¥ä½†ä»éœ€è¦ç”ŸæˆPDFï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ç”¨äºä¸­æ–‡PDFç”Ÿæˆ
          if [ ! -f "ai_news_cn_${{ env.TODAY }}.json" ]; then
            echo "è­¦å‘Š: ç¿»è¯‘å¤±è´¥ï¼Œåˆ›å»ºä¸€ä¸ªå‰¯æœ¬ç”¨äºä¸­æ–‡PDFç”Ÿæˆ"
            cp ai_news_${{ env.TODAY }}.json ai_news_cn_${{ env.TODAY }}.json
          fi

      - name: Install Chinese fonts for PDF generation
        run: |
          sudo apt-get update -y
          sudo apt-get install -y fonts-noto-cjk

      - name: Generate English PDF and Markdown
        run: |
          python generate_pdf.py ai_news_${{ env.TODAY }}.json en

      - name: Generate Chinese PDF and Markdown
        run: |
          python generate_pdf.py ai_news_cn_${{ env.TODAY }}.json zh

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.TAG_DATE }}
          name: "AI News ${{ env.TODAY }}"
          draft: false
          prerelease: false
          files: |
            ai_news_${{ env.TODAY }}.pdf
            ai_news_cn_${{ env.TODAY }}.pdf
            ai_news_${{ env.TODAY }}.md
            ai_news_cn_${{ env.TODAY }}.md
            ai_news_${{ env.TODAY }}.json
            ai_news_cn_${{ env.TODAY }}.json
          body: |
            # AI News Daily Digest ${{ env.TODAY }}
            
            ## ğŸ“„ Available Reports
            
            ### English
            - [PDF](ai_news_${{ env.TODAY }}.pdf) - AI News Daily Digest (PDF format)
            - [Markdown](ai_news_${{ env.TODAY }}.md) - AI News Daily Digest (Markdown format)
            - [JSON](ai_news_${{ env.TODAY }}.json) - Raw data in JSON format
            
            ### Chinese / ä¸­æ–‡
            - [PDF](ai_news_cn_${{ env.TODAY }}.pdf) - AIæ–°é—»æ¯æ—¥ç®€æŠ¥ (PDFæ ¼å¼)
            - [Markdown](ai_news_cn_${{ env.TODAY }}.md) - AIæ–°é—»æ¯æ—¥ç®€æŠ¥ (Markdownæ ¼å¼)
            - [JSON](ai_news_cn_${{ env.TODAY }}.json) - åŸå§‹JSONæ•°æ®
            
            *These reports are automatically generated using NewsAPI and machine translation.*