name: Fetch AI News Daily

on:
  schedule:
    - cron: "0 9 * * *"  # 每天上午9点运行
  workflow_dispatch:     # 允许手动触发

jobs:
  fetch-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # 添加写入仓库内容的权限

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install requests Jinja2 weasyprint
          sudo apt-get update && sudo apt-get install -y libcairo2-dev libpango1.0-dev libgdk-pixbuf2.0-dev libffi-dev shared-mime-info

      - name: Set current date
        id: date
        run: |
          echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "TAG_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Fetch AI News
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: |
          python -c "import os; f=open('fetch_ai_news.py','r'); content=f.read(); f.close(); f=open('fetch_ai_news.py','w'); f.write(content.replace('YOUR_NEWSAPI_KEY', os.environ['NEWS_API_KEY'])); f.close()"
          python fetch_ai_news.py

      - name: Translate News to Chinese
        env:
          # 智谱AI翻译API
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          ZHIPU_MODEL: ${{ secrets.ZHIPU_MODEL || 'glm-4-flash' }}
        run: |
          python translate.py ai_news_${{ env.TODAY }}.json
          # 如果翻译失败但仍需要生成PDF，可以创建一个副本用于中文PDF生成
          if [ ! -f "ai_news_cn_${{ env.TODAY }}.json" ]; then
            echo "警告: 翻译失败，创建一个副本用于中文PDF生成"
            cp ai_news_${{ env.TODAY }}.json ai_news_cn_${{ env.TODAY }}.json
          fi

      - name: Install Chinese fonts for PDF generation
        run: |
          sudo apt-get update -y
          sudo apt-get install -y fonts-noto-cjk

      - name: Generate English PDF and Markdown
        run: |
          python generate_pdf.py ai_news_${{ env.TODAY }}.json en

      - name: Generate Chinese PDF and Markdown
        run: |
          python generate_pdf.py ai_news_cn_${{ env.TODAY }}.json zh

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.TAG_DATE }}
          name: "AI News ${{ env.TODAY }}"
          draft: false
          prerelease: false
          files: |
            ai_news_${{ env.TODAY }}.pdf
            ai_news_cn_${{ env.TODAY }}.pdf
            ai_news_${{ env.TODAY }}.md
            ai_news_cn_${{ env.TODAY }}.md
            ai_news_${{ env.TODAY }}.json
            ai_news_cn_${{ env.TODAY }}.json
          body: |
            # AI News Daily Digest ${{ env.TODAY }}
            
            ## 📄 Available Reports
            
            ### English
            - [PDF](ai_news_${{ env.TODAY }}.pdf) - AI News Daily Digest (PDF format)
            - [Markdown](ai_news_${{ env.TODAY }}.md) - AI News Daily Digest (Markdown format)
            - [JSON](ai_news_${{ env.TODAY }}.json) - Raw data in JSON format
            
            ### Chinese / 中文
            - [PDF](ai_news_cn_${{ env.TODAY }}.pdf) - AI新闻每日简报 (PDF格式)
            - [Markdown](ai_news_cn_${{ env.TODAY }}.md) - AI新闻每日简报 (Markdown格式)
            - [JSON](ai_news_cn_${{ env.TODAY }}.json) - 原始JSON数据
            
            *These reports are automatically generated using NewsAPI and machine translation.*